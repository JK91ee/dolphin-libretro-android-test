name: Build Dolphin Libretro Core (Android ARM64)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build cmake pkg-config python3

      - name: Prepare Externals
        run: |
          mkdir -p Externals

          # Zstd (compression)
          if [ ! -d Externals/zstd ]; then
            git clone --depth=1 https://github.com/facebook/zstd.git Externals/zstd
          fi

          # LZ4 (compression)
          if [ ! -d Externals/lz4 ]; then
            git clone --depth=1 https://github.com/lz4/lz4.git Externals/lz4
          fi

          # zlib-ng (core compression)
          if [ ! -d Externals/zlib-ng ]; then
            git clone --depth=1 https://github.com/zlib-ng/zlib-ng.git Externals/zlib-ng
          fi

          # libspng (PNG support)
          if [ ! -d Externals/libspng ]; then
            git clone --depth=1 https://github.com/randy408/libspng.git Externals/libspng
          fi

          # curl (network)
          if [ ! -d Externals/curl ]; then
            git clone --depth=1 https://github.com/curl/curl.git Externals/curl
          fi

          # mbedtls (crypto)
          if [ ! -d Externals/mbedtls ]; then
            git clone --depth=1 https://github.com/Mbed-TLS/mbedtls.git Externals/mbedtls
          fi

          echo "âœ… Externals prepared."


      - name: Configure build
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLIBRETRO=ON \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_HOME \
            -DCMAKE_ANDROID_STL_TYPE=c++_shared \
            -DCMAKE_ANDROID_API=21 \
            -DENABLE_QT=OFF \
            -DENABLE_WX=OFF \
            -DENABLE_SDL=OFF \
            -DZSTD_INCLUDE_DIRS=$(realpath ../Externals/zstd/lib) \
            -DZSTD_LIBRARY=$(realpath ../Externals/zstd/lib/libzstd.a) \
            -DLZ4_INCLUDE_DIR=$(realpath ../Externals/lz4/lib)

      - name: Build Dolphin libretro core
        run: |
          cd build
          ninja

      - name: Package libretro core
        run: |
          cd build
          mkdir -p output
          # Locate built .so (name can vary slightly)
          CORE_FILE=$(find . -name "*.so" | grep -E "dolphin|libretro" | head -n 1)
          echo "Found core: $CORE_FILE"
          cp "$CORE_FILE" output/dolphin_libretro_android_arm64.so
          cd output
          zip dolphin_libretro_android_arm64.zip dolphin_libretro_android_arm64.so

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dolphin_libretro_android_arm64
          path: build/output/dolphin_libretro_android_arm64.zip
          
